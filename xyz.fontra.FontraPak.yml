id: xyz.fontra.FontraPak
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.7'
command: fontrapak

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --filesystem=xdg-documents
  - --filesystem=xdg-download

modules:
  # Git dependencies for Fontra packages
  - name: fontra-git-dependencies
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/fontra/fontra.git
        commit: FONTRA_COMMIT_PLACEHOLDER
        dest: fontra
      - type: git
        url: https://github.com/fontra/fontra-compile.git
        commit: FONTRA_COMPILE_COMMIT_PLACEHOLDER
        dest: fontra-compile
      - type: git
        url: https://github.com/fontra/fontra-rcjk.git
        commit: FONTRA_RCJK_COMMIT_PLACEHOLDER
        dest: fontra-rcjk
      - type: git
        url: https://github.com/fontra/fontra-glyphs.git
        commit: FONTRA_GLYPHS_COMMIT_PLACEHOLDER
        dest: fontra-glyphs
      - type: git
        url: https://github.com/justvanrossum/delocate.git
        commit: DELOCATE_COMMIT_PLACEHOLDER
        dest: delocate
    build-commands:
      - pip3 install --verbose --prefix=${FLATPAK_DEST} --no-deps ./fontra
      - pip3 install --verbose --prefix=${FLATPAK_DEST} --no-deps ./fontra-compile
      - pip3 install --verbose --prefix=${FLATPAK_DEST} --no-deps ./fontra-rcjk
      - pip3 install --verbose --prefix=${FLATPAK_DEST} --no-deps ./fontra-glyphs
      - pip3 install --verbose --prefix=${FLATPAK_DEST} --no-deps ./delocate

  # PyPI dependencies generated by flatpak-pip-generator
  - pypi-dependencies.json

  # Main FontraPak application
  - name: fontrapak
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/fontra/fontra-pak.git
        tag: 2025.12.2
        commit: FONTRAPAK_COMMIT_PLACEHOLDER
      - type: file
        path: data/icons/xyz.fontra.FontraPak.svg
        dest-filename: xyz.fontra.FontraPak.svg
      - type: file
        path: xyz.fontra.FontraPak.desktop
        dest-filename: xyz.fontra.FontraPak.desktop
      - type: file
        path: xyz.fontra.FontraPak.metainfo.xml
        dest-filename: xyz.fontra.FontraPak.metainfo.xml
    build-commands:
      # Build with PyInstaller
      - pyinstaller --onefile --name fontrapak FontraPakMain.py
      # Install the built binary
      - install -Dm755 dist/fontrapak ${FLATPAK_DEST}/bin/fontrapak
      # Install icon, desktop file and metainfo
      - install -Dm644 xyz.fontra.FontraPak.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/xyz.fontra.FontraPak.svg
      - install -Dm644 xyz.fontra.FontraPak.desktop ${FLATPAK_DEST}/share/applications/xyz.fontra.FontraPak.desktop
      - install -Dm644 xyz.fontra.FontraPak.metainfo.xml ${FLATPAK_DEST}/share/metainfo/xyz.fontra.FontraPak.metainfo.xml
